#Scrip de limpeza de caches
#Feito por Raphael Rezende 06-04-2022
#Adicionar abaixo no crontab -e
#*/30 * * * * /usr/bin/python3 /usr/src/cache.py
import os
from datetime import date, time
from time import sleep
#porcentagem maxima para fazer a limpeza
max_per=90

date=os.popen('date \'+%Y-%m-%d %H:%M\'').read().strip()
# Total da memoria:
ramtotal=int(os.popen('free | grep -i mem | awk \'{print $2}\'').read().strip())
# Memoria livre:
ramlivre=int(os.popen('free | grep -i mem | awk \'{print $4}\'').read().strip())
#Memoria utilizada
ramusada=ramtotal-ramlivre
#Porcentagem usada
porcentagem=int(ramusada*100/ramtotal)
if porcentagem <= max_per:
        print(f'Memoria está em {porcentagem}%')
        os.system(f'echo \'caches em {porcentagem}% {date}\'  >> /tmp/logcaches.log')
if porcentagem >= max_per:
        os.system(f'echo \'limpando  caches {date} porcentagem de ram em {porcentagem}%\' >> /tmp/logcaches.log')
        print(f'Memoria está em {porcentagem}%')
        os.system('echo 3 > /proc/sys/vm/drop_caches')
        # Total da memoria:
        ramtotal=int(os.popen('free | grep -i mem | awk \'{print $2}\'').read().strip())
        # Memoria livre:
        ramlivre=int(os.popen('free | grep -i mem | awk \'{print $4}\'').read().strip())
        #Memoria utilizada
        ramusada=ramtotal-ramlivre
        #Porcentagem usada
        porcentagem=int(ramusada*100/ramtotal)
        os.system('swapoff -a')
        sleep(1)
        os.system('swapon -a')
        os.system(f'echo \'caches limpos {date} porcentagem de ram em {porcentagem}%\' >> /tmp/logcaches.log')
        print(f'Cache limpo =  {porcentagem}%')
